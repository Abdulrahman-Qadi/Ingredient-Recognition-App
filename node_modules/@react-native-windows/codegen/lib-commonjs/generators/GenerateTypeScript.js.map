{"version":3,"file":"GenerateTypeScript.js","sourceRoot":"","sources":["../../src/generators/GenerateTypeScript.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * Copyright (c) Microsoft Corporation.\n * Licensed under the MIT License.\n * @format\n */\n\n'use strict';\n\nimport type {\n  NamedShape,\n  NativeModuleBaseTypeAnnotation,\n  NativeModuleFunctionTypeAnnotation,\n  NativeModuleObjectTypeAnnotation,\n  NativeModuleParamTypeAnnotation,\n  NativeModuleReturnTypeAnnotation,\n  NativeModuleSchema,\n  Nullable,\n  SchemaType,\n} from 'react-native-tscodegen';\n\ninterface CodegenNativeModuleSchema extends NativeModuleSchema {\n  optionalTurboModule?: boolean;\n}\n\nexport function setOptionalTurboModule(\n  schema: NativeModuleSchema,\n  optional: boolean,\n): void {\n  const cs = <CodegenNativeModuleSchema>schema;\n  cs.optionalTurboModule = optional;\n}\n\nexport function getOptionalTurboModule(schema: NativeModuleSchema): boolean {\n  return (<CodegenNativeModuleSchema>schema).optionalTurboModule ?? false;\n}\n\ntype ObjectProp = NamedShape<Nullable<NativeModuleBaseTypeAnnotation>>;\ntype FunctionParam = NamedShape<Nullable<NativeModuleParamTypeAnnotation>>;\ntype FunctionDecl = NamedShape<Nullable<NativeModuleFunctionTypeAnnotation>>;\ntype FilesOutput = Map<string, string>;\n\nconst moduleTemplate = `\n/*\n * This file is auto-generated from a NativeModule spec file in js.\n *\n * This is a TypeScript turbo module definition file.\n */\n\nimport {TurboModule, TurboModuleRegistry} from 'react-native';\n'use strict';\n::_MODULE_ALIASED_STRUCTS_::\nexport interface Spec extends TurboModule {\n::_MODULE_MEMBERS_::\n}\n\nexport default TurboModuleRegistry.::_MODULE_GETTER_::<Spec>('::_MODULE_NAME_::');\n`;\n\nfunction optionalSign<T>(obj: NamedShape<T>): string {\n  return obj.optional ? '?' : '';\n}\n\nfunction translateType(\n  type: Nullable<\n    | NativeModuleBaseTypeAnnotation\n    | NativeModuleParamTypeAnnotation\n    | NativeModuleReturnTypeAnnotation\n  >,\n): string {\n  // avoid: Property 'type' does not exist on type 'never'\n  const returnType = type.type;\n  switch (type.type) {\n    case 'StringTypeAnnotation':\n      return 'string';\n    case 'NumberTypeAnnotation':\n    case 'FloatTypeAnnotation':\n    case 'DoubleTypeAnnotation':\n    case 'Int32TypeAnnotation':\n      return 'number';\n    case 'BooleanTypeAnnotation':\n      return 'boolean';\n    case 'ArrayTypeAnnotation':\n      if (type.elementType) {\n        return `${translateType(type.elementType)}[]`;\n      } else {\n        return `Array`;\n      }\n    case 'GenericObjectTypeAnnotation':\n      return 'object';\n    case 'ObjectTypeAnnotation':\n      return `{${type.properties\n        .map((prop: ObjectProp) => {\n          return `${prop.name}${optionalSign(prop)}: ${translateType(\n            prop.typeAnnotation,\n          )}`;\n        })\n        .join(', ')}}`;\n    case 'ReservedTypeAnnotation': {\n      // avoid: Property 'name' does not exist on type 'never'\n      const name = type.name;\n      // (#6597)\n      // eslint-disable-next-line @typescript-eslint/no-unnecessary-condition\n      if (name !== 'RootTag')\n        throw new Error(\n          `Unknown reserved function: ${name} in translateReturnType`,\n        );\n      return 'number';\n    }\n    case 'TypeAliasTypeAnnotation':\n      return type.name;\n    case 'NullableTypeAnnotation':\n      return `(${translateType(type.typeAnnotation)} | null | undefined)`;\n    case 'VoidTypeAnnotation':\n      return `void`;\n    case 'PromiseTypeAnnotation':\n      return `Promise`;\n    case `FunctionTypeAnnotation`:\n      return `((${type.params\n        .map((param: FunctionParam) => {\n          return `${param.name}${optionalSign(param)}: ${translateType(\n            param.typeAnnotation,\n          )}`;\n        })\n        .join(', ')}) => ${translateType(type.returnTypeAnnotation)})`;\n    default:\n      throw new Error(`Unhandled type in translateReturnType: ${returnType}`);\n  }\n}\n\nfunction translateAlias(\n  name: string,\n  type: NativeModuleObjectTypeAnnotation,\n): string {\n  return `\nexport interface ${name} {\n${type.properties\n  .map((prop: ObjectProp) => {\n    return `  ${prop.name}${optionalSign(prop)}: ${translateType(\n      prop.typeAnnotation,\n    )};`;\n  })\n  .join('\\n')}\n}\n`;\n}\n\nfunction tryGetConstantType(\n  nativeModule: NativeModuleSchema,\n): NativeModuleObjectTypeAnnotation | undefined {\n  const candidates = nativeModule.spec.properties.filter(\n    prop => prop.name === 'getConstants',\n  );\n  if (candidates.length === 0) {\n    return undefined;\n  }\n\n  const getConstant = candidates[0];\n  const funcType =\n    getConstant.typeAnnotation.type === 'NullableTypeAnnotation'\n      ? getConstant.typeAnnotation.typeAnnotation\n      : getConstant.typeAnnotation;\n  if (\n    funcType.params.length > 0 ||\n    funcType.returnTypeAnnotation.type !== 'ObjectTypeAnnotation'\n  ) {\n    return undefined;\n  }\n\n  const constantType = funcType.returnTypeAnnotation;\n  if (constantType.properties.length === 0) {\n    return undefined;\n  }\n\n  return constantType;\n}\n\nfunction translateMethod(func: FunctionDecl): string {\n  const funcType =\n    func.typeAnnotation.type === 'NullableTypeAnnotation'\n      ? func.typeAnnotation.typeAnnotation\n      : func.typeAnnotation;\n\n  return `\n  ${func.name}(${funcType.params\n    .map((param: FunctionParam) => {\n      return `${param.name}${optionalSign(param)}: ${translateType(\n        param.typeAnnotation,\n      )}`;\n    })\n    .join(', ')})${optionalSign(func)}: ${translateType(\n    funcType.returnTypeAnnotation,\n  )}${\n    funcType.returnTypeAnnotation.type === 'ObjectTypeAnnotation' ? '' : ';'\n  }`;\n}\n\nexport function generateTypeScript(\n  _libraryName: string,\n  schema: SchemaType,\n  _moduleSpecName: string,\n): FilesOutput {\n  const files = new Map<string, string>();\n\n  for (const moduleName of Object.keys(schema.modules)) {\n    const nativeModule = schema.modules[moduleName];\n    // from 0.65 facebook's react-native-codegen\n    // the module name has the Native prefix comparing to 0.63\n    // when reading files we provided\n    const nativePrefix = 'Native';\n    const preferredModuleName = moduleName.startsWith(nativePrefix)\n      ? moduleName.substr(nativePrefix.length)\n      : moduleName;\n\n    if (nativeModule.type === 'NativeModule') {\n      console.log(`Generating ${preferredModuleName}Spec.g.ts`);\n\n      const aliasCode = Object.keys(nativeModule.aliases)\n        .map(name => translateAlias(name, nativeModule.aliases[name]))\n        .join('');\n\n      const constantType = tryGetConstantType(nativeModule);\n      const constantCode =\n        constantType === undefined\n          ? ''\n          : `  getConstants(): ${translateType(constantType)}`;\n\n      const methods = nativeModule.spec.properties.filter(\n        prop => prop.name !== 'getConstants',\n      );\n      const membersCode = methods.map(translateMethod).join('');\n\n      files.set(\n        `${preferredModuleName}Spec.g.ts`,\n        moduleTemplate\n          .replace(/::_MODULE_ALIASED_STRUCTS_::/g, aliasCode)\n          .replace(/::_MODULE_MEMBERS_::/g, constantCode + membersCode)\n          .replace(/::_MODULE_NAME_::/g, preferredModuleName)\n          .replace(\n            /::_MODULE_GETTER_::/g,\n            getOptionalTurboModule(nativeModule) ? 'get' : 'getEnforcing',\n          ),\n      );\n    }\n  }\n\n  return files;\n}\n"]}